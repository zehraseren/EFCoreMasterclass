@model List<Message>

@{
    ViewData["Title"] = "MessageList";
    Layout = "~/Views/Layout/Index.cshtml";
    int count = 0;
}

<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Mesaj Listesi</h4>
                <div class="card-description d-flex justify-content-between align-items-center">
                    <code>Mesaj ile ilgili işlemlerinizi buradan yapabilirsiniz.</code>
                    <div class="none-border">
                        <a href="/Message/CreateMessage/" class="btn btn-outline-primary btn-rounded mr-2">Yeni Mesaj Girişi</a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Gönderen</th>
                                <th>Konu</th>
                                <th>Durum</th>
                                <th>Tarih</th>
                                <th>Mesajı Aç</th>
                                <th>Sil</th>
                                <th>Güncelle</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                count++;
                                <tr>
                                    <td>@count</td>
                                    <td>@item.SenderNameSurname</td>
                                    <td>@item.MessageTitle</td>
                                    <td>@(item.IsRead ? "Okundu" : "Okunmadı")</td>
                                    <td>@item.DateTime.ToString("dd MMM yyyy HH:mm ")</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-rounded mark-as-read"
                                                data-id="@item.MessageId"
                                                data-title="@item.MessageTitle"
                                                data-sender="@item.SenderNameSurname"
                                                data-date="@item.DateTime.ToString("dd MMM yyyy HH:mm")"
                                                data-message="@item.MessageDetail">
                                            Mesajı Aç
                                        </button>
                                    </td>
                                    <td><a href="/Message/DeleteMessage/@item.MessageId" class="btn btn-outline-danger btn-rounded">Sil</a></td>
                                    <td><a href="/Message/UpdateMessage/@item.MessageId" class="btn btn-outline-success btn-rounded">Güncelle</a></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mesajı Aç butonuyla mesaj detaylarını göstermek ve mesajı "Okundu" olarak işaretlemek için jQuery ve SweetAlert kullanma  -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Sayfa tamamen yüklendiğinde çalışacak fonksiyon
    $(document).ready(function () {

        // "Mesajı Aç" butonuna tıklandığında tetiklenecek event
        $(".mark-as-read").click(function (e) {
            e.preventDefault(); // Butonun default davranışını engeller (sayfa reload vb.)
            
            // Tıklanan butonun bulunduğu tablo satırını bulur
            var $row = $(this).closest("tr");
            
            // Butondan veri-attribute ile geken bilgileri alır
            var messageId = $(this).data("id");
            var title = $(this).data("title");
            var sender = $(this).data("sender");
            var date = $(this).data("date");
            var messageContent = $(this).data("message");

            // Ajax ile sunucuya POST isteği gönderir
            $.ajax({
                url: '/Message/MarkAsRead', // Controller'daki endpoint
                type: 'POST',
                data: { id: messageId }, // Gönderilen veri (mesaj ID)
                success: function (response) {
                    // Sunucudan başarılı cevap gelirse
                    if (response.success) {
                        // Tablodaki "Durum" hücresini "Okundu" olarak günceller
                        $row.find("td:nth-child(4)").text("Okundu");

                        // SweetAlert ile mesaj detaylarını gösterir
                        Swal.fire({
                            title: `<strong>${title}</strong>`, // Başlık olarak mesaj başlığı
                            html: `
                                <p><b>Gönderen:</b> ${sender}</p>
                                <p><b>Tarih:</b> ${date}</p>
                                <hr>
                                <p>${messageContent}</p>
                            `, // Mesajın içeriğini HTML olarak gösterir
                            confirmButtonText: 'Tamam'
                        });
                    } else {
                        // Eğer sunucu false dönerse hata mesajını gösterir
                        Swal.fire({
                            title: 'Hata!',
                            text: 'Mesaj güncellenemedi.',
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        });
                    }
                },
                error: function () {
                    // Ajax çağrısı hata verirse kullanıcıyı uyarır
                    Swal.fire({
                        title: 'Sunucu Hatası!',
                        text: 'Bir sorun oluştu. Tekrar deneyin.',
                        icon: 'warning',
                        confirmButtonText: 'Tamam'
                    });
                }
            });
        });
    });
</script>
